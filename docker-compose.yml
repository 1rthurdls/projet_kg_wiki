services:
  # 1. Database Service
  neo4j:
    image: neo4j:5
    container_name: neo4j_db
    ports:
      - "7474:7474" # HTTP Browser
      - "7687:7687" # Bolt connection
    environment:
      - NEO4J_AUTH=neo4j/password
      # Allow import from CSVs in your local ./data/import folder
      - NEO4J_server_directories_import=/var/lib/neo4j/import
      - NEO4J_dbms_security_allow__csv__import__from__file__urls=true
    volumes:
      - ./data/import:/var/lib/neo4j/import
      - neo4j_data:/data  # Persist DB data so you don't lose it on restart!
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Application Service
  fastapi:
    build: .  # Builds from the Dockerfile in the current directory
    container_name: fastapi_app
    command: fastapi run main.py --port 8000
    volumes:
      - .:/app  # Sync code changes in real-time (Hot Reload)
    environment:
      # Use the service name 'neo4j' as the hostname
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password
    depends_on:
      neo4j:
        condition: service_healthy # Wait until Neo4j is actually ready
    networks:
      - app_network

  # 3. Additional Service: Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nginx_proxy
    ports:
      - "80:80" # Expose standard web port
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - fastapi
    networks:
      - app_network

# Define volumes for data persistence
volumes:
  neo4j_data:

# Define a custom network so containers can talk to each other
networks:
  app_network: